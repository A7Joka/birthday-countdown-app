<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>المتجر | الرئيسية</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="icon" href="./favicon.ico">
</head>
<body class="bg-gray-50 text-gray-900">
  <header class="bg-white sticky top-0 shadow z-10">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <a href="./" class="font-extrabold text-xl">🛍️ متجري</a>
      <nav class="flex items-center gap-4 text-sm">
        <a href="./" class="hover:text-blue-600">المنتجات</a>
        <a href="./cart.html" class="hover:text-blue-600">السلة</a>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <div class="flex flex-col md:flex-row gap-4 md:items-center md:justify-between mb-6">
      <h1 class="text-2xl font-bold">كل المنتجات</h1>
      <div class="flex gap-2">
        <input id="search" placeholder="ابحث عن منتج..." class="w-64 px-3 py-2 border rounded" />
        <select id="sort" class="px-3 py-2 border rounded">
          <option value="new">الأحدث</option>
          <option value="price-asc">السعر: من الأقل للأعلى</option>
          <option value="price-desc">السعر: من الأعلى للأقل</option>
        </select>
      </div>
    </div>

    <div id="grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>
  </main>

  <footer class="py-8 text-center text-sm text-gray-500">© <span id="year"></span> متجري — نسخة تجريبية</footer>

  <script type="module">
    import { products } from "./assets/store.js";
    import { Cart } from "./assets/cart.js";
    import { formatCurrency, qs } from "./assets/utils.js";

    const grid = document.getElementById('grid');
    const search = document.getElementById('search');
    const sort = document.getElementById('sort');

    function render(list){
      grid.innerHTML = list.map(p => `
        <a href="./product.html?slug=${p.slug}" class="bg-white rounded-2xl overflow-hidden shadow hover:shadow-lg transition block">
          <div class="aspect-w-16 aspect-h-9 bg-gray-100">
            <img src="${p.image}" alt="${p.title}" class="w-full h-56 object-cover">
          </div>
          <div class="p-4">
            <div class="flex items-start justify-between gap-2">
              <h2 class="font-bold">${p.title}</h2>
              <div class="text-sm text-gray-500">${p.badges?.map(b=>`<span class='ml-1 bg-gray-100 border rounded px-2 py-0.5'>${b}</span>`).join('')}</div>
            </div>
            <div class="mt-2 text-lg font-extrabold">
              ${p.discount ? `<span class="text-red-600">${p.discount} ج</span> <span class="line-through text-gray-400 text-base">${p.price} ج</span>` : `${p.price} ج`}
            </div>
            <button data-id="${p.id}" class="mt-3 w-full add bg-blue-600 text-white py-2 rounded hover:bg-blue-700">أضف للسلة</button>
          </div>
        </a>
      `).join('');

      // add to cart buttons
      document.querySelectorAll('.add').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const p = products.find(x => x.id === btn.dataset.id);
          Cart.add(p, 1);
          btn.textContent = '✔ أُضيفت';
          setTimeout(()=> btn.textContent='أضف للسلة', 1200);
        });
      });
    }

    function apply(){
      let list = [...products];
      const q = search.value.trim();
      if(q) list = list.filter(p => p.title.includes(q) || p.description.includes(q));
      if(sort.value === 'price-asc') list.sort((a,b)=> (a.discount ?? a.price) - (b.discount ?? b.price));
      if(sort.value === 'price-desc') list.sort((a,b)=> (b.discount ?? b.price) - (a.discount ?? a.price));
      render(list);
    }

    search.addEventListener('input', apply);
    sort.addEventListener('change', apply);
    apply();
    document.getElementById('year').textContent = new Date().getFullYear();
  </script>
</body>
</html>